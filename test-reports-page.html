<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Page Rapports</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success {
            background: #28a745;
        }
        .button.danger {
            background: #dc3545;
        }
        .data-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .tab.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Test Page Rapports & Factures</h1>
            <p>Cette page teste l'API du Report Service</p>
        </div>

        <div id="status" class="status warning">
            <strong>‚è≥ En attente...</strong>
            <p>Cliquez sur les boutons pour tester</p>
        </div>

        <div class="data-container">
            <h2>üîß Tests</h2>
            <div style="margin: 20px 0;">
                <button class="button" onclick="testAPIGateway()">‚úÖ Tester API Gateway</button>
                <button class="button" onclick="testReportService()">üìÑ Tester Report Service</button>
                <button class="button success" onclick="testReportsAPI()">üìã Tester API Reports</button>
                <button class="button success" onclick="testInvoicesAPI()">üí∞ Tester API Invoices</button>
                <button class="button danger" onclick="generateTestData()">üé≤ G√©n√©rer donn√©es test</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('reports')">üìÑ Rapports</div>
            <div class="tab" onclick="showTab('invoices')">üí∞ Factures</div>
        </div>

        <div id="reports-tab" class="data-container">
            <h2>üìÑ Rapports</h2>
            <button class="button" onclick="loadReports()">üîÑ Charger les rapports</button>
            <div id="reports-list"></div>
        </div>

        <div id="invoices-tab" class="data-container hidden">
            <h2>üí∞ Factures</h2>
            <button class="button" onclick="loadInvoices()">üîÑ Charger les factures</button>
            <div id="invoices-list"></div>
        </div>

        <div class="data-container">
            <h2>üìä Logs</h2>
            <pre id="logs"></pre>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logs.push(logMessage);
            document.getElementById('logs').textContent = logs.join('\n');
            console.log(logMessage);
        }

        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<strong>${message}</strong>`;
        }

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('reports-tab').classList.add('hidden');
            document.getElementById('invoices-tab').classList.add('hidden');
            document.getElementById(`${tab}-tab`).classList.remove('hidden');
        }

        async function testAPIGateway() {
            log('Test API Gateway...');
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                log(`‚úÖ API Gateway OK: ${JSON.stringify(data)}`);
                showStatus('‚úÖ API Gateway fonctionne !', 'success');
                return true;
            } catch (error) {
                log(`‚ùå API Gateway erreur: ${error.message}`, 'error');
                showStatus('‚ùå API Gateway ne r√©pond pas. D√©marrez-le avec: docker-compose up -d api-gateway', 'error');
                return false;
            }
        }

        async function testReportService() {
            log('Test Report Service...');
            try {
                const response = await fetch(`${API_URL}/api/reports`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                log(`‚úÖ Report Service OK: ${data.length} rapports`);
                showStatus(`‚úÖ Report Service fonctionne ! (${data.length} rapports)`, 'success');
                return true;
            } catch (error) {
                log(`‚ùå Report Service erreur: ${error.message}`, 'error');
                showStatus('‚ùå Report Service ne r√©pond pas. D√©marrez-le avec: docker-compose up -d report-service', 'error');
                return false;
            }
        }

        async function testReportsAPI() {
            log('Test API Reports...');
            try {
                const response = await fetch(`${API_URL}/api/reports`);
                const data = await response.json();
                log(`‚úÖ API Reports: ${data.length} rapports trouv√©s`);
                showStatus(`‚úÖ API Reports OK: ${data.length} rapports`, 'success');
                loadReports();
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                showStatus('‚ùå Erreur lors du test', 'error');
            }
        }

        async function testInvoicesAPI() {
            log('Test API Invoices...');
            try {
                const response = await fetch(`${API_URL}/api/invoices`);
                const data = await response.json();
                log(`‚úÖ API Invoices: ${data.length} factures trouv√©es`);
                showStatus(`‚úÖ API Invoices OK: ${data.length} factures`, 'success');
                loadInvoices();
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                showStatus('‚ùå Erreur lors du test', 'error');
            }
        }

        async function loadReports() {
            log('Chargement des rapports...');
            try {
                const response = await fetch(`${API_URL}/api/reports`);
                const data = await response.json();
                
                const listDiv = document.getElementById('reports-list');
                if (data.length === 0) {
                    listDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">Aucun rapport. G√©n√©rez des donn√©es de test.</p>';
                } else {
                    listDiv.innerHTML = data.map(report => `
                        <div class="item">
                            <strong>Rapport #${report.id}</strong><br>
                            Inspection: #${report.inspection_id}<br>
                            Type: ${report.report_type}<br>
                            Statut: ${report.status}<br>
                            Cr√©√©: ${new Date(report.created_at).toLocaleString('fr-FR')}
                        </div>
                    `).join('');
                }
                log(`‚úÖ ${data.length} rapports charg√©s`);
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        async function loadInvoices() {
            log('Chargement des factures...');
            try {
                const response = await fetch(`${API_URL}/api/invoices`);
                const data = await response.json();
                
                const listDiv = document.getElementById('invoices-list');
                if (data.length === 0) {
                    listDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">Aucune facture. G√©n√©rez des donn√©es de test.</p>';
                } else {
                    listDiv.innerHTML = data.map(invoice => `
                        <div class="item">
                            <strong>${invoice.invoice_number}</strong><br>
                            Montant: ${invoice.total_amount?.toFixed(2)} ‚Ç¨<br>
                            Statut: ${invoice.status}<br>
                            √âch√©ance: ${new Date(invoice.due_date).toLocaleDateString('fr-FR')}<br>
                            Cr√©√©: ${new Date(invoice.created_at).toLocaleString('fr-FR')}
                        </div>
                    `).join('');
                }
                log(`‚úÖ ${data.length} factures charg√©es`);
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        async function generateTestData() {
            log('G√©n√©ration de donn√©es de test...');
            showStatus('‚è≥ G√©n√©ration en cours...', 'warning');
            
            try {
                // G√©n√©rer un rapport
                const reportResponse = await fetch(`${API_URL}/api/reports`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        inspection_id: Math.floor(Math.random() * 1000),
                        user_id: 1,
                        report_type: 'inspection_certificate',
                        send_email: false,
                        inspection_data: {
                            inspection_number: `CT-2024-${Math.floor(Math.random() * 1000)}`,
                            inspection_date: new Date().toISOString(),
                            vehicle_registration: 'AB-123-CD',
                            vehicle_brand: 'Renault',
                            vehicle_model: 'Clio',
                            vehicle_year: 2020,
                            mileage: 45000,
                            owner_name: 'Test User',
                            owner_email: 'test@example.com',
                            status: 'passed',
                            inspector_name: 'Inspector Test',
                            checkpoints: [
                                { name: 'Freinage', status: 'passed', result: 'OK' },
                                { name: 'Direction', status: 'passed', result: 'OK' }
                            ]
                        }
                    })
                });
                
                if (reportResponse.ok) {
                    log('‚úÖ Rapport de test cr√©√©');
                }

                // G√©n√©rer une facture
                const invoiceResponse = await fetch(`${API_URL}/api/invoices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 1,
                        amount: 70.00,
                        send_email: false,
                        customer_data: {
                            name: 'Test User',
                            email: 'test@example.com'
                        }
                    })
                });
                
                if (invoiceResponse.ok) {
                    log('‚úÖ Facture de test cr√©√©e');
                }

                showStatus('‚úÖ Donn√©es de test g√©n√©r√©es !', 'success');
                
                // Recharger les donn√©es
                setTimeout(() => {
                    loadReports();
                    loadInvoices();
                }, 500);
                
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                showStatus('‚ùå Erreur lors de la g√©n√©ration', 'error');
            }
        }

        // Auto-test au chargement
        window.onload = async () => {
            log('üöÄ D√©marrage des tests automatiques...');
            const gatewayOk = await testAPIGateway();
            if (gatewayOk) {
                await testReportService();
                await loadReports();
            }
        };
    </script>
</body>
</html>
